---
layout: post
title: "国内服务器备案的绕过测试和遇到的挫败"
comments: true
share: true
tags: Server
---


之前在阿里云买了个ECS，绑定了我博客的未备案域名后，发现能够正常访问，但是过了三天后阿里云打电话过来说我的域名指向没有经过备案，但是我又不想那个服务器就这样丢着浪费，所以开始寻找解决办法，有下面几种解决方案：

## 1.  使用反向代理：rewrite url 但是 浏览器显示的url不变。 ##

方法：一台国外的VPS：A，一台国内主机:B
	
把域名joway.github.io解析到主机A，主机A反向代理到主机B(主机B上的url可以是备案过的域名或者直接是它的ip)

如果是https的，那么两边主机都要配置好https

我用的是nginx，配置文件如下：

国外vps：

joway.github.io.txt:

	server {
	        listen 80;
	        server_name joway.github.io www.joway.github.io;
	        rewrite ^(.*) https://oneoneone.wang$1 permanent;
	}
	
	server {
	        listen      443;
	        server_name  joway.github.io www.joway.github.io;
	        ssl on;
	        ssl_certificate /etc/ssl/private/jowayssl.crt;
	        ssl_certificate_key /etc/ssl/private/jowayssl.key;
	        location / {
	                proxy_redirect https://oneoneone.wang/ /;
	                proxy_cookie_domain oneoneone.wang joway.github.io;
	                proxy_set_header Host oneoneone.wang;
	                proxy_pass https://oneoneone.wang;
	        }
	}

国内vps:

oneoneone.wang.txt:

	server{
	      listen 80;
	      server_name oneoneone.wang;
	      root  /var/www/blog/Joway/_site;
	      location / {
	          rewrite (.*) https://oneoneone.wang$1 permanent;
	      }
	}
	
	server	{
	
	    	listen 443 ssl;
		server_name oneoneone.wang;
		limit_rate 200k;
	
		ssl on;
	    	ssl_certificate /etc/ssl/private/oneoneone.crt;
	    	ssl_certificate_key /etc/ssl/private/oneoneone.key;
	
	        ssl_prefer_server_ciphers on;
	        ssl_dhparam /etc/ssl/certs/dhparam.pem;
	        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	        ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4";
	        keepalive_timeout 70;
	        ssl_session_cache shared:SSL:10m;
	        ssl_session_timeout 10m; 
	
	        add_header Strict-Transport-Security max-age=63072000;
	        add_header X-Frame-Options DENY;
	        add_header X-Content-Type-Options nosniff;
	
		index index.html index.htm index.php;
		root  /var/www/blog/Joway/_site;
		location ~ \.php$ {
			include /etc/nginx/fastcgi_params;
			fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
			fastcgi_pass  127.0.0.1:9000;
		}
	}


这种反向代理还可以对谷歌使用：

go.joway.github.io:

	server {
	        listen 80;
	        server_name go.joway.github.io;
	        rewrite ^(.*) https://go.joway.github.io$1 permanent;
	}
	
	server {
	        listen      443;
	        server_name  go.joway.github.io;
	        ssl on;
	        ssl_certificate /etc/ssl/private/google.crt;
	        ssl_certificate_key /etc/ssl/private/google.key;
	        location / {
	                proxy_redirect https://www.google.com.hk/ /;
	                proxy_cookie_domain google.com.hk go.joway.github.io;
	                proxy_set_header Host www.google.com.hk;
	                proxy_pass https://www.google.com.hk;
	        }
	}

但是，这个方法的速度取决于vps的速度，我简单测试了下发现很慢，而且有掉包。

## 2. 隐形url转发：  ##

这个很多都是要钱的，DNSPod要300块。

## 3. 不使用80端口的话就可以免备案了 ##

如：jowang.wang:81/index.html


